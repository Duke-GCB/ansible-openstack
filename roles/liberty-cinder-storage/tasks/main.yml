---

- name: install cinder storage dependencies
  apt: name={{ item }} state=present
  with_items:
    - lvm2
    - cinder-volume
    - python-mysqldb
  tags:
    - install

- name: create the LVM physical volume
  lvg: vg=vg_cinder pvs={{ CINDER_STORAGE_CONFIG.lvm_pv }} pesize=32

- name: template cinder.conf
  template: src="{{ CINDER_CONFIG.cinder_conf.template }}" dest="{{ CINDER_CONFIG.cinder_conf.dest }}" backup=yes
  tags:
    - cinder
    - template
    - config

- name: populate cinder service database
  shell: su -s /bin/sh -c "cinder-manage db sync" cinder
  tags:
    - cinder
    - db_sync

- name: restart nova-api services on all compute nodes
  service: name=nova-api state=restarted enabled=yes
  delegate_to: "{{ item }}"
  with_items: "{{ COMPUTE_NODES }}"
  tags:
    - compute
    - nova-api-restart

- name: restart block storage services
  service: name={{ item }} state=restarted enabled=yes
  with_items:
    - cinder-scheduler
    - cinder-api
  tags:
    - block-storage-service-restart

- name: remove /var/lib/cinder/cinder.sqlite
  file: path=/var/lib/cinder/cinder.sqlite state=absent
  tags:
    - cleanup